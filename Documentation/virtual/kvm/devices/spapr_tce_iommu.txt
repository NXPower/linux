SPAPR TCE IOMMU device

Capability: no
Architectures: powerpc

Device type supported: KVM_DEV_TYPE_SPAPR_TCE_IOMMU

Groups:
  KVM_DEV_SPAPR_TCE_IOMMU_ATTR_LINKAGE
  Attributes: one VFIO IOMMU fd per LIOBN, indexed by LIOBN

This is completely made up device which provides API to link
logical bus number (LIOBN) and IOMMU group. The user space has
to create a new SPAPR TCE IOMMU device once per KVM session
and use "set_attr" to add or remove a logical bus.

LIOBN is a PCI bus identifier from PPC64-server (sPAPR) DMA hypercalls
(H_PUT_TCE, H_PUT_TCE_INDIRECT, H_STUFF_TCE).
IOMMU group is a minimal isolated device set which can be passed to
the user space via VFIO.

The userspace adds the new LIOBN-IOMMU link by calling KVM_SET_DEVICE_ATTR
with the attribute initialized as shown below:
struct kvm_device_attr attr = {
	.flags = 0,
	.group = KVM_DEV_SPAPR_TCE_IOMMU_ATTR_LINKAGE,
	.attr = liobn,
	.addr = (uint64_t)(uintptr_t)&group_fd,
};

To remove the link, the userspace calls KVM_SET_DEVICE_ATTR with
the group_fd equal to -1.

As the device opens VFIO group fds and holds the file pointer,
it does not need to keep an fd internally and therefore KVM_GET_DEVICE_ATTR
is not supported.

When KVM exits, all links are destroyed automatically.

The kernel does not advertise this feature via capability. Instead,
the userspace calls KVM_CREATE_DEVICE with KVM_CREATE_DEVICE_TEST to
detect the presense of the feature.
